<!doctype html>
<style>
    html, body {
        background-color: #3d3d3d;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        position: relative;
        margin: 0;
    }
    .progress-ring {
        position: absolute;
        top: 5vw;
        width: 90vw;
        height: 90vw;
    }
    #speedometer {
        position: absolute;
        top: 44vw;
        width: 100vw;
        text-align: center;
        font-family: 'Open Sans', sans-serif;
        color: #fff;
        font-size: 72px;
        font-weight: 700;
    }
    .progress-ring__circle {
        transition: stroke-dashoffset 0.35s;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }
    #output { overflow: auto; }
    #output > p { overflow-wrap: break-word; }
    #output span { color: blue; }
    #output span.error { color: red; }
</style>
<html>
    <head>
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
    </head>
    <body>
        <div id="speedometer">0</div>
        <svg class="progress-ring">
        <circle
            class="progress-ring__circle"
            stroke="white"
            stroke-width="20"
            fill="transparent"
            r="40vw"
            cx="44vw"
            cy="44vw"/>
        </svg>
        <div id=output></div>
    </body>
</html>

<script>
    let connected = false,
        error;
    let speed = 0;

    var speedometer = document.querySelector("#speedometer"),
        output = document.querySelector("#output"),
        wsUri = "ws://127.0.0.1/",
        websocket = new WebSocket(wsUri);

    speedometer.innerHTML = "Started";

    websocket.onopen = function (e) {
        writeToScreen("CONNECTED");
        connected = true;
        speedometer.innerHTML = "connected";
    };

    websocket.onclose = function (e) {
        writeToScreen("DISCONNECTED");
        connected = false;
        speedometer.innerHTML = "disconnected";
    };

    websocket.onmessage = function (e) {
        writeToScreen("<span>RESPONSE: " + e.data + "</span>");
        speed = e.data;
        setProgress(speed);
    };

    websocket.onerror = function (e) {
        writeToScreen("<span class=error>ERROR:</span> " + e.data);
        error = e.data;
        speedometer.innerHTML = e.data;
    };
    
    var circle = document.querySelector('circle');
    var radius = circle.r.baseVal.value;
    var circumference = radius * 2 * Math.PI;

    circle.style.strokeDasharray = `${circumference} ${circumference}`;
    circle.style.strokeDashoffset = `${circumference}`;

    function setProgress(percent) {
        console.log("setProgress(percent)", percent);
        const offset = circumference - percent / 100 * circumference;
        circle.style.strokeDashoffset = offset;
        speedometer.innerHTML = percent;
    }
    
    function writeToScreen(message) {
        output.insertAdjacentHTML("afterbegin", "<p>" + message + "</p>");
    }
</script>